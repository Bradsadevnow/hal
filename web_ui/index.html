<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Halcyon Cognitive Console üß†</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #0d1117;
  color: #e6edf3;
  margin: 0;
}
#tab-bar {
  display: flex;
  background: #161b22;
  border-bottom: 1px solid #30363d;
}
.tab {
  flex: 1;
  padding: 0.75rem;
  text-align: center;
  cursor: pointer;
  font-weight: bold;
  color: #e6edf3;
}
.tab.active { background: #238636; }
.window {
  display: none;
  height: calc(100vh - 140px);
  overflow-y: auto;
  padding: 1rem;
}
.window.active { display: block; }
#input-area {
  display: flex;
  border-top: 1px solid #30363d;
}
#query {
  flex: 1;
  padding: 1rem;
  background: #161b22;
  color: #e6edf3;
  border: none;
  outline: none;
  font-size: 1rem;
}
button {
  background: #238636;
  color: #fff;
  border: none;
  padding: 1rem;
  cursor: pointer;
  font-weight: bold;
}
button:hover { background: #2ea043; }

/* Attention Context */
.context-card {
  border: 1px solid #30363d;
  border-radius: 8px;
  background: #161b22;
  padding: 0.75rem;
  margin-bottom: 1rem;
}
.context-card h3 { color: #8ae2ff; margin-top: 0; }

/* Internal monologue style */
.internal-window {
  background-color: #7b9fff22;
  border-left: 4px solid #7b9fff;
  margin: 8px 0;
  padding: 10px;
  border-radius: 8px;
}
.internal-window .header {
  font-weight: bold;
  color: #7b9fff;
  margin-bottom: 6px;
}
.internal-window .state {
  background: #101020;
  color: #b0c8ff;
  padding: 6px;
  border-radius: 6px;
}
.internal-window .reflection {
  color: #cfd8ff;
  font-style: italic;
  margin-top: 4px;
}

/* Memory cards */
.memory-card {
  border: 1px solid #30363d;
  border-radius: 8px;
  padding: 0.75rem;
  margin-bottom: 1rem;
  background: #161b22;
}
.memory-card h3 { margin-top: 0; color: #79c0ff; font-size: 1rem; }
.memory-card pre {
  background: #0d1117;
  color: #79c0ff;
  padding: 0.5rem;
  border-radius: 6px;
  overflow-x: auto;
}
.reflection-pre { color: #00e0ff; }
.reflection-final { color: #ffb347; }
</style>
</head>
<body>

<!-- TAB BAR -->
<div id="tab-bar">
  <div class="tab active" data-target="attention">üß© Attention</div>
  <div class="tab" data-target="reflection">ü©µ Internal Monologue</div>
  <div class="tab" data-target="memory">üß† Memory</div>
</div>

<!-- ATTENTION WINDOW -->
<div id="attention" class="window active">
  <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
    <button onclick="loadAttention()">üîÑ Refresh Attention</button>
  </div>
  <div id="attention-output">Loading attention buffer...</div>
</div>

<!-- REFLECTION WINDOW -->
<div id="reflection" class="window">
  <div id="reflection-log"></div>
</div>

<!-- MEMORY WINDOW -->
<div id="memory" class="window">
  <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
    <button onclick="loadMemories()">üìã View All Memories</button>
    <button onclick="testRecall()">üîç Test Recall</button>
    <button onclick="clearMemories()">‚úï Clear</button>
  </div>
  <div id="memory-output"></div>
</div>

<!-- INPUT -->
<div id="input-area">
  <input id="query" type="text" placeholder="Type your query here...">
  <button id="send">Send</button>
</div>

<script>
const queryBox=document.getElementById("query");
const attentionOut=document.getElementById("attention-output");
const reflectionLog=document.getElementById("reflection-log");
const memoryOut=document.getElementById("memory-output");

/* ---------- Tab Switching ---------- */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".window").forEach(w=>w.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.target).classList.add("active");
  });
});

/* ---------- Send Query ---------- */
async function sendQuery(){
  const q=queryBox.value.trim();
  if(!q)return;
  queryBox.value="";
  try{
    await fetch("/api/turn",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:q})});
  }catch(e){console.error("Error sending query:",e);}
}
document.getElementById("send").onclick=sendQuery;
queryBox.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();sendQuery();}});

/* ---------- Attention ---------- */
async function loadAttention(){
  attentionOut.textContent="Refreshing attention...";
  try{
    const res=await fetch("/api/attention");
    const data=await res.json();
    if(data.error) throw new Error(data.error);
    attentionOut.innerHTML=data.map((turn,i)=>
      `<div class="context-card">
         <h3>Context ${i+1}</h3>
         <pre>${JSON.stringify(turn,null,2)}</pre>
       </div>`
    ).join("");
  }catch(e){attentionOut.textContent="Error: "+e;}
}

/* ---------- Monologue Stream ---------- */
function appendReflection(data){
  const box=document.createElement("div");
  box.className="internal-window";
  box.innerHTML=`
    <div class="header">üß† Internal Monologue ‚Äî Turn ${data.turn_id}</div>
    <pre class="state">${JSON.stringify(data.pre_reflection_state,null,2)}</pre>
    <p class="reflection">${data.pre_reflection_text}</p>`;
  reflectionLog.appendChild(box);
  reflectionLog.scrollTop=reflectionLog.scrollHeight;
}
const evtSource=new EventSource("/api/reflection_raw");
evtSource.onmessage=(event)=>{
  try{
    const data=JSON.parse(event.data);
    if(data.type==="pre_memory_reflection"){appendReflection(data);}
  }catch(e){console.error("Reflection parse error:",e);}
};
evtSource.onerror=(err)=>{console.warn("Reflection stream error:",err);};

/* ---------- Memory ---------- */
async function loadMemories(){
  try{
    const res=await fetch("/api/memories");
    const data=await res.json();
    memoryOut.innerHTML=data.map(m=>`
      <div class="memory-card">
        <h3>üïì ${m.timestamp}</h3>
        <p><b>Query:</b> ${m.query}</p>
        <p><b>Reflection:</b> ${m.reflection}</p>
        <pre>${JSON.stringify(m.state,null,2)}</pre>
      </div>`).join("");
  }catch(e){memoryOut.innerHTML=`<pre>${e}</pre>`;}
}
async function testRecall(){
  const query=prompt("Enter recall query:");if(!query)return;
  const res=await fetch("/api/memory/test-recall",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query})});
  const data=await res.json();
  memoryOut.innerHTML=`<pre>${JSON.stringify(data,null,2)}</pre>`;
}
function clearMemories(){memoryOut.innerHTML="";}
</script>
</body>
</html>
