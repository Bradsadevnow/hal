<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Halcyon Web Console üß†</title>
<style>
body { font-family:'Segoe UI',sans-serif; background:#0d1117; color:#e6edf3; margin:0; }
#tab-bar { display:flex; background:#161b22; border-bottom:1px solid #30363d; }
.tab { flex:1; padding:0.75rem; text-align:center; cursor:pointer; font-weight:bold; }
.tab.active { background:#238636; }
.window { display:none; height:calc(100vh - 140px); overflow-y:auto; padding:1rem; }
.window.active { display:block; }
#input-area { display:flex; border-top:1px solid #30363d; }
#query { flex:1; padding:1rem; background:#161b22; color:#e6edf3; border:none; outline:none; font-size:1rem; }
button { background:#238636; color:#fff; border:none; padding:1rem; cursor:pointer; font-weight:bold; }
button:hover { background:#2ea043; }

.internal-window { background-color:#7b9fff22; border-left:4px solid #7b9fff; margin:8px 0; padding:10px; border-radius:8px; }
.internal-window .header { font-weight:bold; color:#7b9fff; margin-bottom:6px; }
.internal-window .state { background:#101020; color:#b0c8ff; padding:6px; border-radius:6px; }
.internal-window .reflection { color:#cfd8ff; font-style:italic; margin-top:4px; }

.attention-window { background:#ffb34722; border-left:4px solid #ffb347; margin:8px 0; padding:10px; border-radius:8px; }
.attention-window .header { font-weight:bold; color:#ffb347; margin-bottom:6px; }
.attention-window .reflection { color:#ffe0b3; font-style:italic; margin-top:4px; }
.attention-window .response { color:#ffd18a; margin-top:4px; }

.memory-card { border:1px solid #30363d; border-radius:8px; padding:0.75rem; margin-bottom:1rem; background:#161b22; }
.memory-card h3 { margin-top:0; color:#79c0ff; font-size:1rem; }
.memory-card pre { background:#0d1117; color:#79c0ff; padding:0.5rem; border-radius:6px; overflow-x:auto; }
</style>
</head>
<body>

<!-- TAB BAR -->
<div id="tab-bar">
  <div class="tab active" data-target="attention">ü©∏ Attention</div>
  <div class="tab" data-target="reflection">ü©µ Monologue</div>
  <div class="tab" data-target="memory">üß† Memory</div>
</div>

<!-- ATTENTION -->
<div id="attention" class="window active">
  <div id="attention-log">ü©∏ Awaiting attention data...</div>
</div>

<!-- MONOLOGUE -->
<div id="reflection" class="window">
  <div id="reflection-log">ü©µ Awaiting internal monologue...</div>
</div>

<!-- MEMORY -->
<div id="memory" class="window">
  <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
    <button onclick="loadMemories()">üìã View All Memories</button>
    <button onclick="testRecall()">üîç Test Recall</button>
    <button onclick="clearMemories()">‚úï Clear</button>
  </div>
  <div id="memory-output"></div>
</div>

<!-- INPUT -->
<div id="input-area">
  <input id="query" type="text" placeholder="Type your query here...">
  <button id="send">Send</button>
</div>

<script>
const attentionLog=document.getElementById("attention-log");
const reflectionLog=document.getElementById("reflection-log");
const memoryOut=document.getElementById("memory-output");
const queryBox=document.getElementById("query");

function appendAttention(data){
  const box=document.createElement("div");
  box.className="attention-window";
  box.innerHTML=`
    <div class="header">ü©∏ Attention ‚Äî Turn ${data.turn_id}</div>
    <p class="reflection"><b>Final Reflection:</b> ${data.final_reflection}</p>
    <p class="response"><b>Response:</b> ${data.response}</p>`;
  attentionLog.appendChild(box);
  attentionLog.scrollTop=attentionLog.scrollHeight;
}
function appendReflection(data){
  const box=document.createElement("div");
  box.className="internal-window";
  box.innerHTML=`
    <div class="header">üß† Monologue ‚Äî Turn ${data.turn_id}</div>
    <pre class="state">${JSON.stringify(data.pre_reflection_state,null,2)}</pre>
    <p class="reflection">${data.pre_reflection_text}</p>`;
  reflectionLog.appendChild(box);
  reflectionLog.scrollTop=reflectionLog.scrollHeight;
}

// --- STREAMS ---
const monologueStream=new EventSource("/api/reflection_raw");
monologueStream.onmessage=(event)=>{
  try{const data=JSON.parse(event.data);
    if(data.type==="pre_memory_reflection"){appendReflection(data);}
  }catch(e){console.error(e);}
};
monologueStream.onerror=(e)=>console.warn("Monologue stream error:",e);

const attentionStream=new EventSource("/api/attention_feed");
attentionStream.onmessage=(event)=>{
  try{const data=JSON.parse(event.data);
    if(data.type==="attention_update"){appendAttention(data);}
  }catch(e){console.error(e);}
};
attentionStream.onerror=(e)=>console.warn("Attention stream error:",e);

// --- Chat Send ---
async function sendQuery(){
  const q=queryBox.value.trim();
  if(!q)return;
  const res=await fetch("/api/turn",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:q})});
  const data=await res.json();
  console.log("Response:",data);
  queryBox.value="";
}
document.getElementById("send").onclick=sendQuery;
queryBox.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();sendQuery();}});

// --- Memory ---
async function loadMemories(){
  const res=await fetch("/api/memories");const data=await res.json();
  memoryOut.innerHTML=data.map(m=>`
  <div class="memory-card">
    <h3>üïì ${m.timestamp}</h3>
    <p><b>Query:</b> ${m.query}</p>
    <p><b>Reflection:</b> ${m.reflection}</p>
    <pre>${JSON.stringify(m.state,null,2)}</pre>
  </div>`).join("");
}
async function testRecall(){
  const query=prompt("Enter recall query:");if(!query)return;
  const res=await fetch("/api/memory/test-recall",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query})});
  const data=await res.json();memoryOut.innerHTML=`<pre>${JSON.stringify(data,null,2)}</pre>`;
}
function clearMemories(){memoryOut.innerHTML="";}

// --- Tabs ---
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".window").forEach(w=>w.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.target).classList.add("active");
  });
});
</script>
</body>
</html>
