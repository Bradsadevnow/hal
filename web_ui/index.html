<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Halcyon Web Console üß†</title>
<style>
  :root{
    --bg:#0d1117; --panel:#161b22; --line:#30363d; --ok:#238636; --ok2:#2ea043;
    --ink:#e6edf3; --muted:#9ba3af; --blue:#79c0ff; --amber:#ffb347; --amberSoft:#ffd18a;
    --mint:#9fe7a4;
  }
  *{box-sizing:border-box}
  body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--ink);margin:0}
  /* Tabs */
  #tab-bar{display:flex;background:var(--panel);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
  .tab{flex:1;padding:.75rem;text-align:center;cursor:pointer;font-weight:700;user-select:none}
  .tab.active{background:var(--ok)}
  /* Windows */
  .window{display:none;height:calc(100vh - 140px);overflow-y:auto;overflow-x:hidden;padding:1rem}
  .window.active{display:block}
  /* Input */
  #input-area{display:flex;border-top:1px solid var(--line);position:sticky;bottom:0;background:var(--panel)}
  #query{flex:1;padding:1rem;background:var(--panel);color:var(--ink);border:none;outline:none;font-size:1rem}
  button{background:var(--ok);color:#fff;border:none;padding:1rem;cursor:pointer;font-weight:700;border-left:1px solid var(--line)}
  button:hover{background:var(--ok2)}
  /* Cards / blocks */
  .internal-window{background:#1d2330;border-left:4px solid var(--mint);margin:8px 0;padding:12px;border-radius:10px}
  .internal-window .header{font-weight:700;color:var(--mint);margin-bottom:8px}
  .attention-window{background:#2a2116;border-left:4px solid var(--amber);margin:8px 0;padding:12px;border-radius:10px}
  .attention-window .header{font-weight:700;color:var(--amber);margin-bottom:8px}
  .memory-card{border:1px solid var(--line);border-radius:10px;padding:.75rem;margin-bottom:1rem;background:var(--panel)}
  .memory-card h3{margin:.25rem 0;color:var(--blue);font-size:1rem}
  /* Code / pre */
  pre{background:#0b0f14;color:#cfe3ff;border:1px solid #0b2236;border-radius:8px;padding:.75rem;white-space:pre-wrap;word-wrap:break-word;overflow-x:auto}
  code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .kv{color:#cbd5e1}
  /* Inspector layout fixes: independent boxes so they don‚Äôt overwrite each other */
  #inspector-output{display:flex;flex-direction:column;gap:12px}
  #narrative-box, #state-box{min-height:0}
  /* Narrative full view */
  .narrative-entry{border:1px solid var(--line);border-radius:10px;padding:12px;background:#12161d;margin-bottom:10px}
  .narrative-entry h4{margin:0 0 .5rem 0;color:var(--blue)}
  .nmeta{color:var(--muted);font-size:.9rem;margin-bottom:.5rem}
</style>
</head>
<body>

<!-- TAB BAR -->
<div id="tab-bar">
  <div class="tab active" data-target="attention">ü©∏ Attention</div>
  <div class="tab" data-target="inspector">üß© Inspector</div>
  <div class="tab" data-target="memory">üß† Memory</div>
</div>

<!-- ATTENTION -->
<div id="attention" class="window active">
  <div id="attention-log">ü©∏ Awaiting attention data...</div>
</div>

<!-- INSPECTOR -->
<div id="inspector" class="window">
  <div style="display:flex;gap:.5rem;margin-bottom:.5rem;flex-wrap:wrap">
    <button onclick="loadNarrative()">üìñ View Narrative</button>
    <button onclick="loadRecentState()">üß† Current State</button>
  </div>
  <div id="inspector-output">
    <div id="narrative-box">üìñ Awaiting narrative‚Ä¶</div>
    <div id="state-box">üß† Awaiting state‚Ä¶</div>
  </div>
</div>

<!-- MEMORY -->
<div id="memory" class="window">
  <div style="display:flex;gap:.5rem;margin-bottom:.5rem;flex-wrap:wrap">
    <button onclick="loadMemories()">üìã View All Memories</button>
    <button onclick="testRecall()">üîç Test Recall</button>
    <button onclick="clearMemories()">‚úï Clear</button>
  </div>
  <div id="memory-output"></div>
</div>

<!-- INPUT -->
<div id="input-area">
  <input id="query" type="text" placeholder="Type your query here‚Ä¶">
  <button id="send">Send</button>
</div>

<script>
  /* ===== Helpers ===== */
  const attentionLog = document.getElementById("attention-log");
  const memoryOut   = document.getElementById("memory-output");
  const queryBox    = document.getElementById("query");
  const narrativeBox= document.getElementById("narrative-box");
  const stateBox    = document.getElementById("state-box");

  function escapeHTML(s=""){
    return String(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  // Render text, upgrading fenced blocks ```lang ... ``` into <pre><code>
  function renderRichText(text){
    if(!text) return "(none)";
    const m = /^```([\w-]+)?\n([\s\S]*?)```$/m.exec(text.trim());
    if(m){
      const lang = m[1] ? ` class="language-${escapeHTML(m[1])}"` : "";
      return `<pre><code${lang}>${escapeHTML(m[2])}</code></pre>`;
    }
    return `<div class="kv">${escapeHTML(text).replace(/\n/g,"<br>")}</div>`;
  }

  function renderJSON(obj){
    return `<pre><code>${escapeHTML(JSON.stringify(obj, null, 2))}</code></pre>`;
  }

  /* ===== Attention Stream ===== */
  function appendAttention(data){
    if(attentionLog.textContent.includes("Awaiting attention")) attentionLog.innerHTML = "";
    const box = document.createElement("div");
    box.className = "attention-window";
    box.innerHTML = `
      <div class="header">ü©∏ Attention ‚Äî Turn ${data.turn_id}</div>
      <div><b>Final Reflection:</b> ${renderRichText(data.reflection || "(none)")}</div>
      <div><b>Response:</b> ${renderRichText(data.response || "(none)")}</div>
    `;
    attentionLog.appendChild(box);
    attentionLog.scrollTop = attentionLog.scrollHeight;
  }

  function autoRefreshInspector(){ loadRecentState(); loadNarrative(); }

  const attentionStream = new EventSource("/api/attention_feed");
  attentionStream.onmessage = (event)=>{
    try{
      const data = JSON.parse(event.data);
      if(data.type === "attention_update"){
        appendAttention(data);
        autoRefreshInspector();
      }
    }catch(e){ console.error(e); }
  };
  attentionStream.onerror = (e)=>console.warn("Attention stream error:", e);

  /* ===== Chat ===== */
  async function sendQuery(){
    const q = queryBox.value.trim();
    if(!q) return;
    const res = await fetch("/api/turn",{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({query:q})
    });
    await res.json(); // UI updates arrive via SSE
    queryBox.value = "";
  }
  document.getElementById("send").onclick = sendQuery;
  queryBox.addEventListener("keydown",e=>{
    if(e.key==="Enter"){e.preventDefault();sendQuery();}
  });

  /* ===== Memory ===== */
  async function loadMemories(){
    const res = await fetch("/api/memories");
    const data = await res.json();
    memoryOut.innerHTML = data.map(m => `
      <div class="memory-card">
        <h3>üïì ${escapeHTML(m.timestamp || "")}</h3>
        <p><b>Query:</b> ${escapeHTML(m.query || "")}</p>
        <p><b>Reflection:</b> ${escapeHTML(m.reflection || "")}</p>
        ${renderJSON(m.state || {})}
        ${m.keywords?.length ? `<p><b>Keywords:</b> ${m.keywords.map(escapeHTML).join(", ")}</p>` : ""}
      </div>
    `).join("");
  }
  async function testRecall(){
    const query = prompt("Enter recall query:"); if(!query) return;
    const res = await fetch("/api/memory/test-recall",{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({query})
    });
    const data = await res.json();
    memoryOut.innerHTML = renderJSON(data);
  }
  function clearMemories(){ memoryOut.innerHTML = ""; }

  /* ===== Inspector ===== */
  // FULL, NON-TRUNCATED personal narrative view
  async function loadNarrative(){
    const res = await fetch("/api/narrative");
    const data = await res.json();
    const windowArr = Array.isArray(data.window) ? data.window : [];
    if(windowArr.length === 0){
      narrativeBox.innerHTML = `<div class="internal-window">
        <div class="header">üìñ Personal Narrative</div>
        <div class="kv">(no narrative yet)</div>
      </div>`;
      return;
    }
    const full = windowArr.map((n,i)=>`
      <div class="narrative-entry">
        <h4>Entry ${i+1}</h4>
        <div class="nmeta">${escapeHTML(n.timestamp || "")}</div>
        <p><b>Query:</b> ${escapeHTML(n.query || "")}</p>
        <p><b>Reflection:</b></p>${renderRichText(n.reflection || "")}
        <p><b>Response:</b></p>${renderRichText(n.response || "")}
        ${n.linked?.length ? `<p class="nmeta"><b>Linked:</b> ${n.linked.map(escapeHTML).join(", ")}</p>` : ""}
      </div>
    `).join("");
    narrativeBox.innerHTML = `
      <div class="internal-window">
        <div class="header">üìñ Personal Narrative ‚Äî Full Contents</div>
        ${full}
      </div>
    `;
  }

  // Pretty JSON state; lives in its own box (no clobbering narrative)
  async function loadRecentState(){
    const res = await fetch("/api/state");
    const data = await res.json();
    if(data.error){
      stateBox.innerHTML = `<div class="internal-window"><div class="header">üß† Current Cognitive State</div><div class="kv">${escapeHTML(data.error)}</div></div>`;
      return;
    }
    stateBox.innerHTML = `
      <div class="internal-window">
        <div class="header">üß† Current Cognitive State ‚Äî Turn ${escapeHTML(data.turn_id || "")}</div>
        ${renderJSON(data.state || {})}
        <p><b>Reflection:</b></p>${renderRichText(data.reflection || "(none)")}
        <p><b>Keywords:</b> ${(data.keywords || []).map(escapeHTML).join(", ") || "(none)"}</p>
        <p><b>Response:</b></p>${renderRichText(data.response || "(none)")}
      </div>
    `;
  }

  /* ===== Tabs ===== */
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.addEventListener("click",()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".window").forEach(w=>w.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tab.dataset.target).classList.add("active");
    });
  });
</script>

</body>
</html>
